name: iOS (unsigned IPA)

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  runner-health:
    name: Runner health
    runs-on: ubuntu-latest
    outputs:
      try_self_hosted: ${{ steps.decide.outputs.try_self_hosted }}
    steps:
      - name: Decide if self-hosted macOS runner is available
        id: decide
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          runners_http_status="$(
            curl -sS \
              -o runners.json \
              -w '%{http_code}' \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runners" \
              || true
          )"

          echo "Runners API status: $runners_http_status"
          if [[ "$runners_http_status" != "200" ]]; then
            echo "try_self_hosted=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          available="$(
            python3 -c 'import json,sys; data=json.load(sys.stdin); print(sum(1 for r in data.get("runners", []) if str(r.get("status", "")).lower()=="online" and r.get("busy") is False and "macOS" in [l.get("name") for l in r.get("labels", []) if isinstance(l, dict)]))' < runners.json
          )"
          echo "Available self-hosted macOS runners: $available"

          if [[ "$available" -gt 0 ]]; then
            echo "try_self_hosted=true" >> "$GITHUB_OUTPUT"
          else
            echo "try_self_hosted=false" >> "$GITHUB_OUTPUT"
          fi

  build-self-hosted:
    name: Build (self-hosted)
    needs: runner-health
    if: needs.runner-health.outputs.try_self_hosted == 'true'
    runs-on: [self-hosted, macOS]
    outputs:
      succeeded: ${{ steps.build.outcome == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Build unsigned IPA
        id: build
        continue-on-error: true
        run: bash scripts/build-unsigned-ipa.sh

      - uses: actions/upload-artifact@v4
        if: steps.build.outcome == 'success'
        with:
          name: Tyflocentrum-unsigned-ipa
          path: tyflocentrum.ipa

  build-github:
    name: Build (GitHub-hosted)
    needs: [runner-health, build-self-hosted]
    if: always() && needs.build-self-hosted.outputs.succeeded != 'true'
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Build unsigned IPA
        run: bash scripts/build-unsigned-ipa.sh

      - uses: actions/upload-artifact@v4
        with:
          name: Tyflocentrum-unsigned-ipa
          path: tyflocentrum.ipa
